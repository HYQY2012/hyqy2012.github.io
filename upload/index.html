<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYQY Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
* { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
body { background: #ffffff; color: #000000; transition: all 0.3s ease; }
.github-box { border: 1px solid #d1d5db; border-radius: 6px; transition: all 0.2s ease; }
.github-box:hover { border-color: #9ca3af; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.github-btn { background: #000; color: #fff; border-radius: 6px; transition: all 0.2s ease; }
.github-btn:hover { background: #222; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.github-btn:active { transform: translateY(0); }
.github-tab { border-bottom: 2px solid transparent; transition: all 0.2s ease; cursor: pointer; }
.github-tab.active { border-color: #000; color: #000; }
.github-tab:hover { color: #4b5563; }
input, textarea { transition: all 0.2s ease; }
input:focus, textarea:focus { border-color: #6366f1; box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.2); }
.hidden { display: none; }
.fade-in { animation: fadeIn 0.3s ease forwards; }
.fade-out { animation: fadeOut 0.3s ease forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
#msg { transition: all 0.3s ease; }
</style>
</head>
<body class="min-h-screen">
<div class="max-w-3xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold tracking-tight mb-8 text-center">HYQY Chat</h1>

  <div id="auth-view" class="github-box p-6 max-w-sm mx-auto fade-in">
    <div class="flex gap-6 mb-6">
      <div id="tab-login" class="github-tab active px-1 py-2 font-medium">登录</div>
      <div id="tab-register" class="github-tab px-1 py-2 font-medium">注册</div>
    </div>

    <div id="login-panel">
      <div class="mb-4">
        <label class="block text-sm mb-1">用户名</label>
        <input id="login-user" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <div class="mb-5">
        <label class="block text-sm mb-1">密码</label>
        <input id="login-pwd" type="password" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <button id="do-login" class="github-btn w-full py-2 font-medium">登录</button>
    </div>

    <div id="register-panel" class="hidden">
      <div class="mb-3">
        <label class="block text-sm mb-1">用户名</label>
        <input id="reg-user" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <div class="mb-3">
        <label class="block text-sm mb-1">密码</label>
        <input id="reg-pwd" type="password" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <button id="do-register" class="github-btn w-full py-2 font-medium">注册</button>
    </div>
  </div>

  <div id="main-view" class="hidden fade-in">
    <div class="github-box p-4 mb-4 flex justify-between items-center">
      <div>欢迎，<span id="show-user"></span></div>
      <button id="logout" class="text-sm border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 transition">退出</button>
    </div>

    <div class="github-box p-6 mb-4">
      <div class="mb-4">
        <label class="block text-sm mb-1">文件 ID（5 位字符）</label>
        <input id="file-id" placeholder="xxxxx" maxlength="5" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>

      <div class="mb-4">
        <label class="block text-sm mb-1">上传本地图片</label>
        <label for="upload-img" class="github-btn px-3 py-1 text-sm inline-block cursor-pointer">
          选择图片 <input id="upload-img" type="file" accept="image/*" class="hidden">
        </label>
        <span id="img-name" class="text-sm ml-2 text-gray-500"></span>
      </div>

      <div class="mb-4">
        <label class="block text-sm mb-1">内容（支持 MD）</label>
        <textarea id="content" rows="8" placeholder="# 标题
**加粗**
- 列表
![图片](url)" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
      </div>

      <button id="upload" class="github-btn px-4 py-2 font-medium">上传到 GitHub</button>
    </div>

    <div id="msg" class="text-sm text-center"></div>
  </div>
</div>

<script>
const CONFIG = {
  token: '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',
  owner: 'HYQY2012',
  userRepo: 'users',
  dataRepo: 'data',
  branch: 'main'
}

const tabLogin = document.getElementById('tab-login')
const tabRegister = document.getElementById('tab-register')
const loginPanel = document.getElementById('login-panel')
const registerPanel = document.getElementById('register-panel')
const imgName = document.getElementById('img-name')

tabLogin.onclick = () => {
  tabLogin.classList.add('active')
  tabRegister.classList.remove('active')
  loginPanel.classList.remove('hidden')
  registerPanel.classList.add('hidden')
}
tabRegister.onclick = () => {
  tabRegister.classList.add('active')
  tabLogin.classList.remove('active')
  registerPanel.classList.remove('hidden')
  loginPanel.classList.add('hidden')
}

function sha256(str) {
  return btoa(unescape(encodeURIComponent(str)))
}

function toast(text) {
  const msg = document.getElementById('msg')
  msg.textContent = text
  msg.style.opacity = 1
  setTimeout(() => { 
    msg.style.opacity = 0
    setTimeout(() => msg.textContent = '', 300)
  }, 3000)
}

document.getElementById('do-register').onclick = async () => {
  const user = document.getElementById('reg-user').value.trim()
  const pwd = document.getElementById('reg-pwd').value.trim()
  
  if (!user || !pwd) return toast('请输入用户名和密码')
  if (user.length < 3 || pwd.length < 6) return toast('用户名至少3位，密码至少6位')

  try {
    const fileName = `users_${user}.json`
    const userData = JSON.stringify({
      username: user,
      password: sha256(pwd),
      createdAt: new Date().toISOString()
    }, null, 2)

    await uploadToRepo(CONFIG.userRepo, fileName, userData)
    toast('注册成功！请登录')
    tabLogin.click()
  } catch (e) {
    toast('注册失败：' + e.message)
    console.error(e)
  }
}

document.getElementById('do-login').onclick = async () => {
  const user = document.getElementById('login-user').value.trim()
  const pwd = document.getElementById('login-pwd').value.trim()
  
  if (!user || !pwd) return toast('请输入用户名和密码')

  try {
    const userFileData = await getFile(CONFIG.userRepo, `users_${user}.json`)
    if (!userFileData || !userFileData.content) throw new Error('用户数据异常')

    const userInfo = JSON.parse(atob(userFileData.content))
    if (userInfo.password !== sha256(pwd)) throw new Error('密码错误')

    localStorage.setItem('hyqy-user', user)
    showMain()
    toast('登录成功！')
  } catch (e) {
    if (e.message.includes('Not Found')) {
      toast('登录失败：用户不存在，请先注册')
    } else if (e.message === '密码错误') {
      toast('登录失败：密码错误')
    } else {
      toast('登录失败：' + e.message)
    }
    console.error(e)
  }
}

document.getElementById('upload').onclick = async () => {
  const id = document.getElementById('file-id').value.trim()
  const text = document.getElementById('content').value.trim()
  
  if (id.length !== 5) return toast('请输入 5 位文件 ID')
  if (!text) return toast('请输入内容')

  const htmlContent = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HYQY ${id}</title>
<style>body{max-width:800px;margin:0 auto;padding:2rem;font-family:system-ui;}</style>
</head>
<body>
${mdToHtml(text)}
</body>
</html>`

  try {
    await uploadToRepo(CONFIG.dataRepo, `id_${id}.html`, htmlContent)
    toast(`上传成功：https://github.com/${CONFIG.owner}/${CONFIG.dataRepo}/blob/${CONFIG.branch}/id_${id}.html`)
  } catch (e) {
    toast('上传失败：' + e.message)
    console.error(e)
  }
}

document.getElementById('upload-img').onchange = function (e) {
  const file = e.target.files[0]
  if (!file) {
    imgName.textContent = ''
    return
  }
  
  imgName.textContent = file.name
  const reader = new FileReader()
  reader.onload = () => {
    const currContent = document.getElementById('content').value
    document.getElementById('content').value = `${currContent}\n![本地图片](${reader.result})`
    toast('图片已插入编辑区')
  }
  reader.readAsDataURL(file)
}

async function getFile(repo, path) {
  const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${repo}/contents/${path}`, {
    method: 'GET',
    headers: { 
      'Authorization': `token ${CONFIG.token}`,
      'Accept': 'application/vnd.github.v3+json'
    }
  })

  if (!response.ok) {
    const errData = await response.json()
    throw new Error(errData.message || '获取文件失败')
  }
  return await response.json()
}

async function uploadToRepo(repo, path, content) {
  let sha = ''
  try {
    const existingFile = await getFile(repo, path)
    sha = existingFile.sha
  } catch (e) {
    console.log('文件不存在，将创建新文件：', path)
  }

  const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${CONFIG.token}`,
      'Content-Type': 'application/json',
      'Accept': 'application/vnd.github.v3+json'
    },
    body: JSON.stringify({
      message: `HYQY Chat: ${new Date().toLocaleString()}`,
      content: btoa(unescape(encodeURIComponent(content))),
      branch: CONFIG.branch,
      sha: sha || undefined
    })
  })

  if (!response.ok) {
    const errData = await response.json()
    throw new Error(errData.message || '上传文件失败')
  }
  return await response.json()
}

function mdToHtml(md) {
  return md
    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^- (.*)$/gm, '<li>$1</li>')
    .replace(/!\[(.*?)\]\((.*?)\)/g, '<img alt="$1" src="$2" style="max-width:100%;margin:1rem 0;">')
    .replace(/\n/g, '<br>')
}

function showMain() {
  document.getElementById('auth-view').classList.add('fade-out')
  setTimeout(() => {
    document.getElementById('auth-view').classList.add('hidden')
    document.getElementById('main-view').classList.remove('hidden')
    document.getElementById('show-user').textContent = localStorage.getItem('hyqy-user')
  }, 300)
}

document.getElementById('logout').onclick = () => {
  localStorage.clear()
  document.getElementById('main-view').classList.add('fade-out')
  setTimeout(() => location.reload(), 300)
}

window.onload = () => {
  if (localStorage.getItem('hyqy-user')) showMain()
}
</script>
</body>
</html>
