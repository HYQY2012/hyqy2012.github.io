<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HYQY Chat</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
* { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
body { background: #ffffff; color: #000000; }
.github-box { border: 1px solid #d1d5db; border-radius: 6px; }
.github-btn { background: #000; color: #fff; border-radius: 6px; }
.github-btn:hover { background: #222; }
.github-tab { border-bottom: 2px solid transparent; }
.github-tab.active { border-color: #000; color: #000; }
</style>
</head>
<body class="min-h-screen">
<div class="max-w-3xl mx-auto px-4 py-10">
  <h1 class="text-3xl font-bold tracking-tight mb-8 text-center">HYQY Chat</h1>

  <div id="auth-view" class="github-box p-6 max-w-sm mx-auto">
    <div class="flex gap-6 mb-6">
      <div id="tab-login" class="github-tab active px-1 py-2 font-medium cursor-pointer">登录</div>
      <div id="tab-register" class="github-tab px-1 py-2 font-medium cursor-pointer">注册</div>
    </div>

    <div id="login-panel">
      <div class="mb-4">
        <label class="block text-sm mb-1">用户名</label>
        <input id="login-user" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <div class="mb-5">
        <label class="block text-sm mb-1">密码</label>
        <input id="login-pwd" type="password" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <button id="do-login" class="github-btn w-full py-2 font-medium">登录</button>
    </div>

    <div id="register-panel" class="hidden">
      <div class="mb-3">
        <label class="block text-sm mb-1">用户名</label>
        <input id="reg-user" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <div class="mb-3">
        <label class="block text-sm mb-1">密码</label>
        <input id="reg-pwd" type="password" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>
      <button id="do-register" class="github-btn w-full py-2 font-medium">注册</button>
    </div>
  </div>

  <div id="main-view" class="hidden">
    <div class="github-box p-4 mb-4 flex justify-between items-center">
      <div>欢迎，<span id="show-user"></span></div>
      <button id="logout" class="text-sm border border-gray-300 px-3 py-1 rounded">退出</button>
    </div>

    <div class="github-box p-6 mb-4">
      <div class="mb-4">
        <label class="block text-sm mb-1">文件 ID（5 位字符）</label>
        <input id="file-id" placeholder="xxxxx" maxlength="5" class="w-full border border-gray-300 rounded px-3 py-2">
      </div>

      <div class="mb-4">
        <label class="block text-sm mb-1">内容/图片（支持 MD）</label>
        <input id="upload-img" type="file" accept="image/*" class="text-sm mb-2 block">
        <textarea id="content" rows="8" placeholder="# 标题
**加粗**
- 列表
![图片](url)" class="w-full border border-gray-300 rounded px-3 py-2"></textarea>
      </div>

      <button id="upload" class="github-btn px-4 py-2 font-medium">上传到 GitHub</button>
    </div>

    <div id="msg" class="text-sm text-center"></div>
  </div>
</div>

<script>
const CONFIG = {
  token: '',
  owner: 'HYQY2012',
  userRepo: 'users',
  dataRepo: 'data',
  branch: 'main'
}

const tabLogin = document.getElementById('tab-login')
const tabRegister = document.getElementById('tab-register')
const loginPanel = document.getElementById('login-panel')
const registerPanel = document.getElementById('register-panel')

tabLogin.onclick = () => {
  tabLogin.classList.add('active')
  tabRegister.classList.remove('active')
  loginPanel.classList.remove('hidden')
  registerPanel.classList.add('hidden')
}
tabRegister.onclick = () => {
  tabRegister.classList.add('active')
  tabLogin.classList.remove('active')
  registerPanel.classList.remove('hidden')
  loginPanel.classList.add('hidden')
}

function sha256(str) {
  return btoa(unescape(encodeURIComponent(str)))
}

function toast(text) {
  document.getElementById('msg').textContent = text
  setTimeout(() => { document.getElementById('msg').textContent = '' }, 3000)
}

document.getElementById('do-register').onclick = async () => {
  const user = document.getElementById('reg-user').value.trim()
  const pwd = document.getElementById('reg-pwd').value.trim()
  if (!user || !pwd) return toast('请输入用户名和密码')

  const fileName = `users_${user}.json`
  const content = JSON.stringify({
    username: user,
    password: sha256(pwd),
    createdAt: new Date().toISOString()
  }, null, 2)

  try {
    await uploadToRepo(CONFIG.userRepo, fileName, content)
    toast('注册成功！请登录')
    tabLogin.click()
  } catch (e) {
    toast('注册失败：' + e.message)
  }
}

document.getElementById('do-login').onclick = async () => {
  const user = document.getElementById('login-user').value.trim()
  const pwd = document.getElementById('login-pwd').value.trim()
  if (!user || !pwd) return toast('请输入用户名和密码')

  try {
    const data = await getFile(CONFIG.userRepo, `users_${user}.json`)
    const local = JSON.parse(atob(data.content))
    if (local.password !== sha256(pwd)) throw new Error('密码错误')

    localStorage.setItem('hyqy-user', user)
    showMain()
  } catch (e) {
    toast('登录失败：' + e.message)
  }
}

document.getElementById('upload').onclick = async () => {
  const id = document.getElementById('file-id').value.trim()
  const text = document.getElementById('content').value.trim()
  if (id.length !== 5) return toast('请输入 5 位文件 ID')
  if (!text) return toast('请输入内容')

  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HYQY ${id}</title>
<style>body{max-width:800px;margin:0 auto;padding:2rem;font-family:system-ui;}</style>
</head>
<body>
${mdToHtml(text)}
</body>
</html>`

  try {
    await uploadToRepo(CONFIG.dataRepo, `id_${id}.html`, html)
    toast('上传成功：https://github.com/HYQY2012/data/blob/main/id_' + id + '.html')
  } catch (e) {
    toast('上传失败：' + e.message)
  }
}

document.getElementById('upload-img').onchange = function (e) {
  const file = e.target.files[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = () => {
    const curr = document.getElementById('content').value
    document.getElementById('content').value = curr + '\n![image](' + reader.result + ')'
    toast('已插入图片')
  }
  reader.readAsDataURL(file)
}

async function getFile(repo, path) {
  const r = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${repo}/contents/${path}`, {
    headers: { Authorization: `token ${CONFIG.token}` }
  })
  if (!r.ok) throw new Error((await r.json()).message)
  return await r.json()
}

async function uploadToRepo(repo, path, content) {
  let sha = ''
  try {
    const cur = await getFile(repo, path)
    sha = cur.sha
  } catch {}

  const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      Authorization: `token ${CONFIG.token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: `HYQY Chat save ${path}`,
      content: btoa(unescape(encodeURIComponent(content))),
      sha: sha || undefined
    })
  })

  if (!res.ok) throw new Error((await res.json()).message)
  return await res.json()
}

function mdToHtml(md) {
  return md
    .replace(/^### (.*$)/gm, '<h3>$1</h3>')
    .replace(/^## (.*$)/gm, '<h2>$1</h2>')
    .replace(/^# (.*$)/gm, '<h1>$1</h1>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/^- (.*)$/gm, '<li>$1</li>')
    .replace(/!\[(.*?)\]\((.*?)\)/g, '<img alt="$1" src="$2" style="max-width:100%">')
    .replace(/\n/g, '<br>')
}

function showMain() {
  document.getElementById('auth-view').classList.add('hidden')
  document.getElementById('main-view').classList.remove('hidden')
  document.getElementById('show-user').textContent = localStorage.getItem('hyqy-user')
}

document.getElementById('logout').onclick = () => {
  localStorage.clear()
  location.reload()
}

window.onload = () => {
  if (localStorage.getItem('hyqy-user')) showMain()
}
</script>
</body>
</html>
