<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>HHAT Upload</title>
</head>
<body>
  <input id="userFolder" placeholder="英文文件夹名" value="test123">
  <button onclick="doUpload()">上传</button>
  <div id="result"></div>

  <script>
    // ########## 只改这里 ##########
    const GITHUB_TOKEN = "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";
    const OWNER = "HYQY2012";
    const REPO = "Data";

    const headers = {
      "Authorization": "token " + GITHUB_TOKEN,
      "Accept": "application/vnd.github.v3+json"
    };

    async function doUpload() {
      const r = document.getElementById("result");
      const folder = document.getElementById("userFolder").value.trim();
      r.textContent = "加载中...";

      try {
        // 1. 先验证仓库（你已经200）
        const repoRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}`, {
          method: "GET",
          headers,
          mode: "cors",
          credentials: "omit"
        });
        console.log("仓库验证状态:", repoRes.status); // 必200

        // 2. 拿目录页数
        const listRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${folder}`, {
          method: "GET",
          headers,
          mode: "cors",
          credentials: "omit"
        });

        let pageNum = 1;
        if (listRes.status === 200) {
          const files = await listRes.json();
          const pages = files
            .filter(i => i.type === "dir" && /^page_\d+$/.test(i.name))
            .map(i => parseInt(i.name.split("_")[1]))
            .filter(n => !isNaN(n));
          if (pages.length) pageNum = Math.max(...pages) + 1;
        }

        // 3. 上传
        const path = `${folder}/page_${pageNum}/index.md`;
        const content = btoa(unescape(encodeURIComponent(`# ${folder} page ${pageNum}\n上传成功`)));

        const uploadRes = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`, {
          method: "PUT",
          headers,
          mode: "cors",
          credentials: "omit",
          body: JSON.stringify({
            message: `upload ${path}`,
            content: content
          })
        });

        const data = await uploadRes.json();
        r.textContent = uploadRes.ok ? `成功: ${data.content.html_url}` : `失败: ${data.message}`;
      } catch (e) {
        r.textContent = "异常: " + e.message;
      }
    }
  </script>
</body>
</html>
