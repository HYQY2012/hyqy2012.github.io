<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD 编号生成+上传（API版）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 500px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.06); }
        .title { text-align: center; color: #2c3e50; margin-bottom: 25px; font-size: 22px; }
        .btn { width: 100%; padding: 12px; background: #27ae60; color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        .btn:hover { background: #219653; }
        .result { margin-top: 20px; padding: 18px; border-radius: 8px; font-size: 17px; min-height: 80px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .loading { background: #e3f2fd; color: #0d47a1; }
        .success { background: #e8f5e9; color: #1b5e20; }
        .error { background: #ffebee; color: #c62828; }
        .file-name { font-weight: 700; font-size: 20px; margin: 8px 0; letter-spacing: 1px; }
        .opt-btn { margin: 5px; padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; color: #fff; transition: opacity 0.3s; }
        .opt-btn.copy { background: #2196f3; }
        .opt-btn.upload { background: #ff9800; }
        .opt-btn:hover { opacity: 0.9; }
        .tip { margin-top: 15px; font-size: 13px; color: #666; text-align: center; line-height: 1.5; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">MD 文件编号生成器<br/><small style="font-size:14px; color:#666">仅上传至 md data 目录</small></h1>
        <button class="btn" id="generateBtn">生成下一个 MD 文件名</button>
        <div class="result" id="result">点击上方按钮，生成自增MD文件名（index_0001.md ~ index_9999.md）</div>
        <p class="tip">生成后可直接复制文件名，或点击「一键上传」跳转到GitHub，自动填充文件名，仅需填写内容即可保存</p>
    </div>

    <script>
        // ########## 仅需修改这一行！！！ ##########
        const GITHUB_TOKEN = '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';
        // 固定配置（无需修改）
        const CONFIG = {
            owner: 'HYQY2012',
            repo: 'Data',
            path: 'md data', // 目标目录，固定不变
            prefix: 'index_',
            suffix: '.md',
            numLength: 4,
            maxNum: 9999
        };

        // 全局元素
        const generateBtn = document.getElementById('generateBtn');
        const resultEl = document.getElementById('result');

        // 请求头（GitHub官方推荐Bearer鉴权，跨域兼容拉满）
        const REQ_HEADERS = {
            'Authorization': `Bearer ${GITHUB_TOKEN.trim()}`,
            'Accept': 'application/vnd.github.v3+json',
            'X-GitHub-Api-Version': '2022-11-28'
        };

        // 1. 获取已存在的MD文件编号
        async function getExistingNumbers() {
            const encodePath = encodeURIComponent(CONFIG.path);
            const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${encodePath}`;
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: REQ_HEADERS,
                mode: 'cors',
                credentials: 'omit', // 禁止带Cookie，避免鉴权冲突
                cache: 'no-store'    // 禁止缓存，保证获取最新文件列表
            });

            if (!response.ok) throw new Error(`API请求失败 [${response.status}]，请检查Token是否有效`);
            const contents = await response.json();

            // 筛选index_xxxx.md文件，提取数字编号
            const reg = new RegExp(`^${CONFIG.prefix}(\\d{${CONFIG.numLength}})${CONFIG.suffix}$`);
            const numbers = [];
            contents.forEach(item => {
                if (item.type === 'file' && reg.test(item.name)) {
                    const num = parseInt(reg.exec(item.name)[1], 10);
                    numbers.push(num);
                }
            });
            return numbers;
        }

        // 2. 生成下一个自增编号
        function getNextNumber(numbers) {
            if (numbers.length === 0) return 1;
            const maxNum = Math.max(...numbers);
            if (maxNum >= CONFIG.maxNum) throw new Error(`已达最大编号 ${CONFIG.prefix}${CONFIG.maxNum.toString().padStart(4,0)}${CONFIG.suffix}，无法生成`);
            return maxNum + 1;
        }

        // 3. 格式化4位编号（0001/0002...）
        function formatNum(num) {
            return num.toString().padStart(CONFIG.numLength, '0');
        }

        // 4. 复制文件名到剪贴板
        function copyFileName(name) {
            navigator.clipboard.writeText(name).then(() => {
                alert(`✅ 已复制：${name}`);
            }).catch(() => {
                alert(`❌ 复制失败，请手动复制：${name}`);
            });
        }

        // 5. 跳转GitHub一键上传页（自动填充文件名）
        function jumpToUpload(name) {
            const encodePath = encodeURIComponent(`${CONFIG.path}/${name}`);
            const uploadUrl = `https://github.com/${CONFIG.owner}/${CONFIG.repo}/new/main/${encodePath}`;
            window.open(uploadUrl, '_blank'); // 新窗口打开
        }

        // 主逻辑：生成文件名
        async function generateFileName() {
            // 加载状态
            generateBtn.disabled = true;
            resultEl.className = 'result loading';
            resultEl.innerHTML = '正在读取md data目录文件列表...';

            try {
                // 核心步骤：读编号→生新号→格式化
                const existingNums = await getExistingNumbers();
                const nextNum = getNextNumber(existingNums);
                const nextNumStr = formatNum(nextNum);
                const newFileName = `${CONFIG.prefix}${nextNumStr}${CONFIG.suffix}`;

                // 成功展示
                resultEl.className = 'result success';
                resultEl.innerHTML = `
                    生成成功！<br/>
                    下一个MD文件名：
                    <div class="file-name">${newFileName}</div>
                    <button class="opt-btn copy" onclick="copyFileName('${newFileName}')">复制文件名</button>
                    <button class="opt-btn upload" onclick="jumpToUpload('${newFileName}')">一键上传到GitHub</button>
                `;
            } catch (err) {
                // 错误展示
                resultEl.className = 'result error';
                resultEl.innerHTML = `生成失败：<br/>${err.message}`;
            } finally {
                // 恢复按钮
                generateBtn.disabled = false;
            }
        }

        // 绑定点击事件
        generateBtn.addEventListener('click', generateFileName);
        // 暴露全局方法（供按钮调用）
        window.copyFileName = copyFileName;
        window.jumpToUpload = jumpToUpload;
    </script>
</body>
</html>
