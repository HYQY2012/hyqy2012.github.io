<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://www.xn--vqq068m4ham0n.space/img/logo.svg">
<title>HYQY Chat</title>
<style>
:root{--primary:#1a1a1a;--secondary:#333;--accent:#666;--light:#f8f8f8;--success:#22c55e;--error:#ef4444;--transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
body{background:var(--light);color:var(--primary);min-height:100vh;line-height:1.6}
.navbar{background:#fff;padding:1.2rem 5%;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,0.08);position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,0.02)}
.logo{font-size:1.5rem;font-weight:700;color:var(--primary);text-decoration:none;letter-spacing:-0.02em}
.publish-btn-nav{background:var(--primary);color:#fff;padding:0.6rem 1.5rem;border-radius:8px;text-decoration:none;font-weight:500;transition:var(--transition)}
.publish-btn-nav:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.1)}
.content-section{padding:5rem 5%}
.section-title{font-size:2rem;font-weight:700;text-align:center;margin-bottom:4rem;position:relative}
.section-title::after{content:'';display:block;width:50px;height:3px;background:var(--primary);margin:1rem auto 0;border-radius:3px}
.content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:2rem;max-width:1400px;margin:0 auto}
.content-card{background:#fff;border-radius:16px;padding:2rem;border:1px solid rgba(0,0,0,0.08);box-shadow:0 5px 20px rgba(0,0,0,0.03);transition:var(--transition);opacity:0;transform:translateY(20px);animation:fadeUp 0.3s ease forwards}
@keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
.content-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,0.08)}
.card-author{font-weight:600;margin-bottom:0.8rem;color:var(--primary)}
.card-time{font-size:0.9rem;color:var(--accent);margin-bottom:1.5rem;display:block}
.card-content{color:var(--secondary);line-height:1.7;margin-bottom:1.5rem}
.card-actions{display:flex;justify-content:space-between;align-items:center;padding-top:1rem;border-top:1px solid rgba(0,0,0,0.05)}
.like-btn{display:flex;align-items:center;gap:0.5rem;background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.95rem;transition:var(--transition)}
.like-btn:hover{color:var(--error)}
.like-btn.liked{color:var(--error)!important}
.comment-btn{display:flex;align-items:center;gap:0.5rem;background:none;border:none;color:var(--accent);cursor:pointer;font-size:0.95rem;transition:var(--transition)}
.comment-btn:hover{color:var(--primary)}
.comments-section{margin-top:1.5rem;max-height:0;overflow:hidden;transition:var(--transition)}
.comments-section.active{max-height:500px}
.comment-input{width:100%;padding:0.8rem 1rem;border:1px solid rgba(0,0,0,0.1);border-radius:8px;margin-bottom:1rem;resize:none;min-height:80px;font-size:0.95rem}
.comment-submit{background:var(--primary);color:#fff;border:none;padding:0.6rem 1.2rem;border-radius:6px;cursor:pointer;font-size:0.9rem;transition:var(--transition)}
.comment-submit:hover{opacity:0.9}
.comment-submit:disabled{opacity:0.6;cursor:not-allowed}
.comments-list{margin-top:1rem}
.comment-item{padding:1rem;background:var(--light);border-radius:8px;margin-bottom:0.8rem}
.comment-author{font-weight:600;font-size:0.9rem;margin-bottom:0.3rem}
.comment-text{font-size:0.95rem;color:var(--secondary)}
.loading{text-align:center;padding:4rem;color:var(--accent);font-size:1.1rem}
.toast{position:fixed;bottom:20px;right:20px;padding:1rem 1.5rem;background:var(--primary);color:#fff;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,0.1);z-index:1000;opacity:0;transition:var(--transition)}
.toast.show{opacity:1;transform:translateY(0)}
.toast.error{background:var(--error)}
.toast.success{background:var(--success)}
.empty{grid-column:1/-1;text-align:center;padding:4rem;color:var(--accent)}
</style>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<nav class="navbar">
<a href="#" class="logo">HYQY Chat</a>
<a href="./upload/" class="publish-btn-nav">发布内容</a>
</nav>

<section id="content" class="content-section">
<h2 class="section-title">聊天内容</h2>
<div class="content-grid" id="content-grid">
<div class="loading">
<i class="fas fa-spinner fa-spin" style="font-size:2rem;margin-bottom:1rem;display:block"></i>加载中...</div>
</div>
</section>

<div class="toast" id="toast"></div>

<script>
const CONFIG = {
  baseUrl: "https://www.xn--vqq068m4ham0n.space/articles",
  token: "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",
  repoApi: "https://api.github.com/repos/HYQY2012/hyqy2012.github.io/contents/articles"
};
const START = 1;
const END = 9999;
let fileShaMap = {};
let localLiked = new Set();

document.addEventListener("DOMContentLoaded", async () => {
  await loadAllFiles();
});

async function loadAllFiles() {
  const grid = document.getElementById("content-grid");
  grid.innerHTML = "";
  let found = 0;

  for (let i = START; i <= END; i++) {
    const numStr = i.toString().padStart(4, "0");
    const fileName = `data_${numStr}.json`;
    const jsonUrl = `${CONFIG.baseUrl}/${fileName}`;
    
    try {
      const fileInfoRes = await fetch(`${CONFIG.repoApi}/${fileName}`, {
        headers: { 
          Authorization: `token ${CONFIG.token}`,
          Accept: 'application/vnd.github.v3+json'
        }
      });
      
      if (fileInfoRes.ok) {
        const fileInfo = await fileInfoRes.json();
        fileShaMap[numStr] = fileInfo.sha;
      }

      const ctrl = new AbortController();
      setTimeout(() => ctrl.abort(), 3000);
      const res = await fetch(jsonUrl, { signal: ctrl.signal });
      
      if (!res.ok) continue;
      const data = await res.json();
      
      if ((data.userLiked || []).includes("visitor")) {
        localLiked.add(numStr);
      }
      
      renderCard(numStr, data);
      found++;
    } catch (e) {
      continue;
    }
  }

  if (found === 0) {
    grid.innerHTML = `<div class="empty"><i class="fas fa-file-code" style="font-size:3rem;margin-bottom:1rem"></i><h3>暂无内容</h3></div>`;
  }
}

function renderCard(id, data) {
  const grid = document.getElementById("content-grid");
  const card = document.createElement("div");
  card.className = "content-card";
  card.setAttribute("data-id", id);

  const likes = data.likes || 0;
  const comments = data.comments || [];
  const isLiked = localLiked.has(id);

  function formatDate(t) {
    try {
      return new Intl.DateTimeFormat("zh-CN", {
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      }).format(new Date(t));
    } catch (e) {
      return "未知时间";
    }
  }

  card.innerHTML = `
    <span class="card-author">${data.user || "匿名"}</span>
    <span class="card-time">${formatDate(data.publishTime)}</span>
    <div class="card-content">${(data.content || "").replace(/\n/g, "<br>")}</div>
    <div class="card-actions">
      <button class="like-btn ${isLiked ? 'liked' : ''}" data-id="${id}">
        <i class="fas fa-heart"></i>
        <span class="like-count">${likes}</span>
      </button>
      <button class="comment-btn" data-id="${id}">
        <i class="fas fa-comment"></i>
        <span>${comments.length}</span>
      </button>
    </div>
    <div class="comments-section" id="comments-${id}">
      <textarea class="comment-input" placeholder="写下评论..."></textarea>
      <button class="comment-submit" data-id="${id}">发布评论</button>
      <div class="comments-list">
        ${comments.map(c => `
        <div class="comment-item">
          <div class="comment-author">${c.author || "访客"}</div>
          <div class="comment-text">${c.text}</div>
        </div>`).join("")}
      </div>
    </div>
  `;
  grid.appendChild(card);
  
  const likeBtn = card.querySelector(".like-btn");
  likeBtn.addEventListener("click", async function() {
    const id = this.getAttribute("data-id");
    const fileName = `data_${id}.json`;
    const countEl = this.querySelector(".like-count");
    let currentLikes = parseInt(countEl.textContent);
    
    if (localLiked.has(id)) {
      this.classList.remove("liked");
      countEl.textContent = currentLikes - 1;
      localLiked.delete(id);
    } else {
      this.classList.add("liked");
      countEl.textContent = currentLikes + 1;
      localLiked.add(id);
    }

    try {
      const res = await fetch(`${CONFIG.baseUrl}/${fileName}`);
      const data = await res.json();
      
      data.likes = localLiked.has(id) ? currentLikes + 1 : currentLikes - 1;
      data.userLiked = data.userLiked || [];
      data.userLiked = localLiked.has(id) 
        ? [...new Set([...data.userLiked, "visitor"])] 
        : data.userLiked.filter(u => u !== "visitor");
      
      await updateGithubFile(fileName, data, id);
      showToast("点赞状态已同步", "success");
    } catch (err) {
      if (localLiked.has(id)) {
        this.classList.remove("liked");
        countEl.textContent = currentLikes;
        localLiked.delete(id);
      } else {
        this.classList.add("liked");
        countEl.textContent = currentLikes;
        localLiked.add(id);
      }
      showToast("点赞同步失败，请重试", "error");
      console.error("点赞API失败：", err);
    }
  });

  const commentBtn = card.querySelector(".comment-btn");
  commentBtn.addEventListener("click", function() {
    const id = this.getAttribute("data-id");
    const section = document.getElementById(`comments-${id}`);
    section.classList.toggle("active");
  });

  const commentSubmit = card.querySelector(".comment-submit");
  commentSubmit.addEventListener("click", async function() {
    const id = this.getAttribute("data-id");
    const fileName = `data_${id}.json`;
    const input = this.parentElement.querySelector(".comment-input");
    const text = input.value.trim();
    const list = this.parentElement.querySelector(".comments-list");
    const countEl = card.querySelector(".comment-btn span");

    if (!text) return;
    this.disabled = true;
    this.textContent = "发布中...";

    try {
      const res = await fetch(`${CONFIG.baseUrl}/${fileName}`);
      const data = await res.json();
      
      data.comments = data.comments || [];
      const newComment = {
        author: "访客",
        text: text,
        time: new Date().toISOString()
      };
      data.comments.push(newComment);
      
      await updateGithubFile(fileName, data, id);
      
      const item = document.createElement("div");
      item.className = "comment-item";
      item.innerHTML = `<div class="comment-author">访客</div><div class="comment-text">${text}</div>`;
      list.appendChild(item);
      
      countEl.textContent = data.comments.length;
      input.value = "";
      showToast("评论发布成功", "success");
    } catch (err) {
      showToast("评论发布失败", "error");
      console.error(err);
    } finally {
      this.disabled = false;
      this.textContent = "发布评论";
    }
  });
}

async function updateGithubFile(fileName, content, id) {
  const sha = fileShaMap[id];
  if (!sha) throw new Error("文件SHA不存在");
  
  const contentStr = JSON.stringify(content, null, 2);
  const base64Content = btoa(unescape(encodeURIComponent(contentStr)));

  const res = await fetch(`${CONFIG.repoApi}/${fileName}`, {
    method: "PUT",
    headers: {
      Authorization: `token ${CONFIG.token}`,
      "Content-Type": "application/json",
      Accept: "application/vnd.github.v3+json"
    },
    body: JSON.stringify({
      message: `更新${fileName}的点赞/评论`,
      content: base64Content,
      sha: sha,
      branch: "main"
    })
  });

  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    throw new Error(errData.message || `HTTP ${res.status}`);
  }
  
  const result = await res.json();
  fileShaMap[id] = result.content.sha;
}

function showToast(msg, type = "success") {
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.className = `toast show ${type}`;
  setTimeout(() => toast.classList.remove("show"), 2000);
}
</script>
</body>
</html>
